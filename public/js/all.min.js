"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var socket=io(),app=angular.module("ships",[]).controller("shipCon",["$scope",function(e){e.id=Math.floor(1e16*Math.random()).toString(32);var t=function e(t,o,r,n,s){_classCallCheck(this,e),this.type=t||"structural",this.px=o,this.py=r,this.x="l"==n?o-1:"r"==n?o+1:o,this.y="t"==n?r-1:"b"==n?r+1:r,this.deets=s||{},this.hp=100};e.pos={x:90,y:90},e.noBubble=function(e){e.stopPropagation()},e.removeKey=function(t){e.currKeys.slice(t,1)},e.pickStats=function(t,o){"gun"==t.type?(e.currKeys=t.keys||[],e.deetPart=o,e.$digest()):"engine"==t.type&&(e.currKeys=t.keys||[],e.deetPart=o,e.$digest())},e.parseNewKey=function(t){console.log(t);var o=t.key.toUpperCase();1==o.length&&o.charCodeAt(0)>64&&o.charCodeAt(0)<91?e.newKey=o:(o="ENTER")&&(console.log("ENTER PRESSED!"),e.currKeys.push(e.newKey),e.newKey="")},e.deetPart=-1,e.specialLeft=5,e.totalLeft=10,e.removeLast=function(){if(e.parts.length<2)return!1;"structural"!=e.parts.pop().type&&e.specialLeft++,e.totalLeft++,e.partsLocs.pop()},e.checkPartObst=function(t,o){return e.partsLocs.indexOf(t+":"+o)>-1},e.parts=[],e.buildMode=!0,e.partsLocs=["0:0"],e.parts.push(new t("structural",0,0,null)),e.makeNewPart=function(o,r,n){if(n.preventDefault(),console.log("E",n.altKey,n.ctrlKey),e.building)return!1;var s={p:0,r:0,keys:[]},i="structural";if(n.altKey||n.ctrlKey?n.altKey?n.ctrlKey?(i="shield",s.p=30,s.r=0):(i="gun",s.p=30,s.r=0,s.keys=[]):(i="engine",s.p=5,s.r=0,s.keys=[]):i="structural","structural"!=i&&e.specialLeft--,e.specialLeft<0)bootbox.alert({title:"Invalid Part",message:"You have no more special parts left!"}),e.specialLeft=0;else{var a=new t(i,o.x,o.y,r,s);if(e.checkPartObst(a.x,a.y))return console.log("part already here!",a),!1;e.totalLeft--,e.parts.push(a),e.partsLocs.push(a.x+":"+a.y),e.building=!0,e.buildTimer=setTimeout(function(){e.building=!1},500)}},e.checkEdge=function(t,o){return!("l"==o&&e.partsLocs.indexOf(t.x-1+":"+t.y)>-1)&&(!("r"==o&&e.partsLocs.indexOf(t.x+1+":"+t.y)>-1)&&(!("t"==o&&e.partsLocs.indexOf(t.x+":"+(t.y-1))>-1)&&(!("b"==o&&e.partsLocs.indexOf(t.x+":"+(t.y+1))>-1)&&!!e.totalLeft)))},e.getCgStyle=function(){var t=e.partsLocs.map(function(e){return e.split(":").map(function(e){return parseInt(e)})}),o=0,r=0;return t.forEach(function(e){o+=e[0],r+=e[1]}),{x:o/t.length,y:r/t.length}},e.getScales=function(){var e=Math.max(document.querySelector("body > div > div.ship-container").scrollHeight,document.querySelector("body > div > div.ship-container").scrollWidth),t=-.01*e+1.5;return t+","+t},e.shipRot=0,window.onkeydown=function(t){e.buildMode?65==t.which?e.shipRot-=3:68==t.which?e.shipRot+=3:27==t.which&&e.removeLast():e.getAccels(t),e.$digest()},e.getMass=function(e){var t=e.filter(function(e){return"structural"==e.type}).length,o=e.filter(function(e){return"engine"==e.type}).length,r=e.filter(function(e){return"gun"==e.type}).length;return 1*t+1.9*o+1.2*e.filter(function(e){return"shield"==e.type}).length+1.5*r},e.play=function(){for(var t="",o=0;o<e.parts.length;o++)"engine"!=e.parts[o].type&&"gun"!=e.parts[o].type||e.parts[o].keys&&e.parts[o].keys.length||(t="<br>Warning: One or more of your activateable parts (engine or gun) has no keys mapped to it.");bootbox.confirm("Are you sure you want to use this design to play?"+t,function(t){t&&null!=t&&(e.buildMode=!1,e.ship={parts:angular.copy(e.parts),score:0,extra:0,x:Math.floor(500*Math.random()),y:Math.floor(500*Math.random()),r:Math.floor(360*Math.random()),vx:0,vy:0,vr:0,mass:e.getMass(e.parts),id:e.id},console.log("SHIP:",e.ship),socket.emit("newPlayer",e.ship),e.$digest())})};var o=$(window).width(),r=$(window).height();e.playDisp=function(){return e.ship?{x:0-(e.ship.x-o/2),y:0-(e.ship.y-r/2)}:{x:0,y:0}},e.constExplain=function(){bootbox.alert({title:"Ship-Building Controls",message:"To build your ship, use the following controls:<ul><li>To place a structural part, click an exposed edge.</li><li>To place an engine, hold CTRL and click an exposed edge.</li><li>To place an gun, hold ALT and click an exposed edge.</li><li>To place an shield, hold CTRL+ALT and click an exposed edge.</li><li>To remove the last part, click the undo button or press ESC.</li><li>Press A or D to rotate your ship in or out.</li><li>Click PLAY when you're happy with your design!</li></ul>"})},e.getAccels=function(t){if(1!=t.key.toUpperCase().length||t.key.toUpperCase().charCodeAt(0)<65||t.key.toUpperCase().charCodeAt(0)>90)return!1;for(var o=e.getCgStyle(),r=0,n=0,s=0;s<e.parts.length;s++)if("engine"==e.parts[s].type&&e.parts[s].keys.indexOf(t.key.toUpperCase())>-1){var i=e.parts[s].x-o.x,a=e.parts[s].y-o.y,l=Math.atan(a/i);n+=e.parts[s].deets.p*Math.sin(l),r+=e.parts[s].deets.p*Math.cos(l),console.log("engine",s,"xDiff",i,"yDiff",a)}console.log("THRUSTS:",n,r),e.ship.vr-=r,e.ship.vx+=n*Math.sin(e.ship.r*Math.PI/180),e.ship.vy-=n*Math.cos(e.ship.r*Math.PI/180),console.log("SHIP TO BACKEND:",e.ship),socket.emit("playerMove",e.ship)},console.log("socket.on",socket),e.bgPos={x:0,y:0},socket.on("shipPosits",function(t){console.log("SHIP UPDATE",t.ships.length?t.ships[0].vy:""),e.allShips=t.ships;for(var o=0;o<t.ships.length;o++)t.ships[o].id==e.id&&(e.ship=t.ships[o]);e.lazers=t.lazers,e.bgPos=e.playDisp(),e.$digest()})}]);app.controller("phone-con",["$scope","contFact",function(e,t){e.phoneName=Math.floor(999999999*Math.random()).toString(32).toUpperCase(),e.user=!1,e.role=!1,e.initZero=!1,e.zero={x:null,y:null,z:null},e.currOri={},socket.emit("newPhone",e.phoneName),socket.on("regPhone",function(t){e.phoneName==t.name&&(e.user=t.u,e.role=t.role,e.$apply())}),e.showInf=function(e){e?1==e?bootbox.alert('The game code corresponds to the particular "instance" of the desktop site your phone is connected with.'):bootbox.alert("If set to collective, your phone controls average blade angle. If set to cyclic, your phone controls, generally speaking, the direction of the craft. Finally, if set to joystick, the phone acts as an airplane joystick (plane mode only)."):bootbox.alert("Enter this automatically-generated phone code for the cyclic, collective, or joystick on the desktop site.")},e.setZero=function(){e.zero=angular.copy(e.currOri)},window.addEventListener("deviceorientation",function(o){e.currOri.x=o.beta,e.currOri.y=o.gamma,e.currOri.z=o.alpha,e.initZero||(e.initZero=!0,e.setZero()),t.handleOri(e.zero,e.currOri,e.user,e.role)}),e.reZero=function(){bootbox.confirm("Are you sure you want to re-zero?",function(t){t&&e.setZero()})}}]);